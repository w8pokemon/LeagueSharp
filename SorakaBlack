using System;
using System.Collections.Generic;
using System.Linq;
using System.Runtime.ExceptionServices;
using System.Security.Cryptography;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Input;
using LeagueSharp;
using LeagueSharp.Common;
using SharpDX;

namespace SorakaBlack
{
    internal class Program
    {
        private static Spell Q;
        private static Spell W;
        private static Spell E;
        private static Spell R;
        private static TargetSelector ts;
        private static GameObject ward;
        private static Vector3 spawn;
        private static bool recalling = false;
        private static Menu menu;
        private static int[] ids;
        private static int index = 0;
        private static double count;
        private static bool stopdoingshit = false;
        private static double foundturret;
        private static Obj_AI_Turret turret;
        private static double gamestart;
        private static ItemToShop nextItem;
        private static List<ItemToShop> buyThings;
        private static List<Obj_AI_Hero> allies;
        private static int i = 0;

        private static readonly string[] ad =
        {
            "Ashe", "Caitlyn", "Corki", "Draven", "Ezreal", "Graves", "Jinx", "Kalista", "KogMaw", "Lucian",
            "MissFortune", "Quinn", "Sivir", "Tristana", "Twitch", "Varus", "Vayne"
        };

        private static readonly string[] ap =
        {
            "Ahri", "Akali", "Anivia", "Annie", "Brand", "Cassiopeia", "Diana",
            "FiddleSticks", "Fizz", "Gragas", "Heimerdinger", "Karthus", "Kassadin", "Katarina", "Kayle", "Kennen",
            "Leblanc", "Lissandra", "Lux", "Malzahar", "Mordekaiser", "Morgana", "Nidalee", "Orianna", "Ryze", "Sion",
            "Swain", "Syndra", "Teemo", "TwistedFate", "Veigar", "Viktor", "Vladimir", "Xerath", "Ziggs", "Zyra",
            "Velkoz"
        };

        private static Obj_AI_Hero follow;
        private static double followtime;

        private static void Main(string[] args)
        {
            CustomEvents.Game.OnGameLoad += Game_OnGameLoad;
            CustomEvents.Game.OnGameEnd += Game_OnGameEnd;
        }

        static void Game_OnGameEnd(EventArgs args)
        {
            Game.PrintChat("GG");
        }

        private static void Game_OnGameLoad(EventArgs args)
        {
            Game.PrintChat("Soraka<font color='#000000'>Black</font> " + "loaded successfully.");
            Game.PrintChat("Made by blm95 and updated by w8pokemon.");
            
            if (ObjectManager.Player.ChampionName != "Soraka") return;
            allies = new List<Obj_AI_Hero>();
            Q = new Spell(SpellSlot.Q, 970);
            W = new Spell(SpellSlot.W, 550);
            E = new Spell(SpellSlot.E, 925);
            R = new Spell(SpellSlot.R);
            ts = new TargetSelector(1025, TargetSelector.TargetingMode.AutoPriority);
            spawn =
                ObjectManager.Get<GameObject>()
                    .First(x => x.Type == GameObjectType.obj_SpawnPoint && x.Team == ObjectManager.Player.Team)
                    .Position;
            menu = new Menu("SorakaBlack", "slack", true);
            menu.AddItem(new MenuItem("on", "Start Slacking!").SetValue(new KeyBind(32, KeyBindType.Toggle)));
            menu.AddItem(new MenuItem("user", "Use R?").SetValue(true));
            menu.AddItem(new MenuItem("usew", "Use W?").SetValue(true));
            menu.AddItem(new MenuItem("allyhpw", "Ally % HP for W").SetValue(new Slider(30, 0, 93)));
            menu.AddItem(new MenuItem("wabovehp", "Use W when my hp > x%").SetValue(new Slider(20, 0, 99)));
            menu.AddItem(new MenuItem("allyhpr", "Ally % HP for R").SetValue(new Slider(30, 0, 50)));
            menu.AddItem(new MenuItem("hpb", "B if hp < %").SetValue(new Slider(15, 0, 80)));
            menu.AddSubMenu(new Menu("Follow:", "follower"));
            
            foreach (var ally in ObjectManager.Get<Obj_AI_Hero>().Where(x => x.IsAlly && !x.IsMe))
            {
                allies.Add(ally);
                if (ad.Contains(ally.ChampionName))
                    menu.SubMenu("follower").AddItem(new MenuItem(ally.ChampionName, ally.ChampionName).SetValue(true));
                else
                    menu.SubMenu("follower").AddItem(new MenuItem(ally.ChampionName, ally.ChampionName).SetValue(false));
            }

            buyThings = new List<ItemToShop>
            {
                new ItemToShop()
                {
                    goldReach = 500,
                    itemsMustHave = new List<int>{3301},
                    itemIds = new List<int>{3096}
                },
                new ItemToShop()
                {
                    goldReach = 360,
                    itemsMustHave = new List<int>{3096},
                    itemIds = new List<int>{1004,1004}
                },
                new ItemToShop()
                {
                    goldReach = 500,
                    itemsMustHave = new List<int>{1004,1004},
                    itemIds = new List<int>{1033}
                },
                new ItemToShop()
                {
                    goldReach = 180,
                    itemsMustHave = new List<int>{1033,1004,1004},
                    itemIds = new List<int>{3028}
                },
                new ItemToShop()
                {
                    goldReach = 325,
                    itemsMustHave = new List<int>{3028},
                    itemIds = new List<int>{1001}
                },
                new ItemToShop()
                {
                    goldReach = 675,
                    itemsMustHave = new List<int>{1001},
                    itemIds = new List<int>{3009}
                },
                new ItemToShop()
                {
                    goldReach = 400,
                    itemsMustHave = new List<int>{3009},
                    itemIds = new List<int>{1028}
                },
                new ItemToShop()
                {
                    goldReach = 450,
                    itemsMustHave = new List<int>{1028},
                    itemIds = new List<int>{3067}
                },
                new ItemToShop()
                {
                    goldReach = 400,
                    itemsMustHave = new List<int>{3067},
                    itemIds = new List<int>{1028}
                },
                new ItemToShop()
                {
                    goldReach = 800,
                    itemsMustHave = new List<int>{1028},
                    itemIds = new List<int>{3211}
                },
                new ItemToShop()
                {
                    goldReach = 700,
                    itemsMustHave = new List<int>{3211},
                    itemIds = new List<int>{3065}
                },
                new ItemToShop()
                {
                    goldReach = 2900,
                    itemsMustHave = new List<int>{},
                    itemIds = new List<int>{3116}
                },
            };

            var sequence = new[] { 2, 1, 3, 2, 2, 4, 2, 1, 2, 1, 4, 1, 1, 3, 3, 4, 3, 3 };
            var level = new AutoLevel(sequence);
            
            gamestart = Game.Time;
            
            menu.AddToMainMenu();
            ids = new[] { 3096, 1004, 1004, 1033, 1001, 3028, 3174, 3009, 1028, 3067, 1028, 3211, 3065, 3069, 1028, 2049, 2045 };

            followtime = Game.Time;

            Packet.C2S.BuyItem.Encoded(new Packet.C2S.BuyItem.Struct(3301)).Send();
            Packet.C2S.BuyItem.Encoded(new Packet.C2S.BuyItem.Struct(3340)).Send();
            Packet.C2S.BuyItem.Encoded(new Packet.C2S.BuyItem.Struct(2003)).Send();
            Packet.C2S.BuyItem.Encoded(new Packet.C2S.BuyItem.Struct(2003)).Send();
            Packet.C2S.BuyItem.Encoded(new Packet.C2S.BuyItem.Struct(2003)).Send();

            Game.OnGameUpdate += Game_OnGameUpdate;

        }

        private static void Game_OnGameProcessPacket(GamePacketEventArgs args)
        {
            GamePacket p = new GamePacket(args.PacketData);
            if (p.Header != Packet.S2C.TowerAggro.Header) return;
            if (Packet.S2C.TowerAggro.Decoded(args.PacketData).TargetNetworkId != ObjectManager.Player.NetworkId)
                return;
            if (Game.Time - foundturret > 20 && !recalling)
            {
                var turret2 =
                    ObjectManager.Get<Obj_AI_Turret>()
                        .Where(x => x.Distance(ObjectManager.Player) < 3500 && x.IsAlly);

                if (turret2.Any())
                {
                    stopdoingshit = true;
                    turret = turret2.First();
                    foundturret = Game.Time;
                }
            }


            if (!stopdoingshit || recalling) return;
            ObjectManager.Player.IssueOrder(GameObjectOrder.MoveTo, turret);
            if (!(ObjectManager.Player.Distance(turret) <= 350) || !(Game.Time - count > 5)) return;
            ObjectManager.Player.Spellbook.CastSpell(SpellSlot.Recall);

            recalling = true;
            count = Game.Time;
        }

        internal class ItemToShop
        {
            public int goldReach;
            public List<int> itemIds;
            public List<int> itemsMustHave;
        }

        private static bool checkItemcount(ItemToShop its)
        {
            bool[] usedItems = new bool[7];
            int itemsMatch = 0;
            foreach (int t in its.itemsMustHave)
            {
                for (int i = 0; i < ObjectManager.Player.InventoryItems.Count(); i++)
                {
                    if (usedItems[i])
                        continue;
                    if (t != (decimal)ObjectManager.Player.InventoryItems[i].Id) continue;
                    usedItems[i] = true;
                    itemsMatch++;
                    break;
                }
            }
            return itemsMatch == its.itemsMustHave.Count;
        }

        private static void Game_OnGameUpdate(EventArgs args)
        {
            if (Items.HasItem(ids[index]))
                index++;
            Console.WriteLine("Recalling = " + recalling);

            Console.WriteLine("stop: " + stopdoingshit);
            if (Game.Time - foundturret > 25)
                stopdoingshit = false;
            if (Utility.InShopRange())
            {
                if (!Items.HasItem(ids[index]))
                {
                    Packet.C2S.BuyItem.Encoded(new Packet.C2S.BuyItem.Struct(ids[index])).Send();

                }
            }

            follow = ObjectManager.Get<Obj_AI_Hero>().First(x => menu.Item(x.ChampionName).GetValue<bool>());
            Console.WriteLine(follow.IsDead);
            if ((follow.IsDead ||
                 (follow.Distance(ObjectManager.Player.Position) > 5000 && !Utility.InShopRange() &&
                  spawn.Distance(follow.Position) < 1500) ||
                 ObjectManager.Player.Health / ObjectManager.Player.MaxHealth * 100 <
                 menu.Item("hpb").GetValue<Slider>().Value))
            {

                if (Game.Time - foundturret > 20 && !recalling)
                {
                    var turret2 =
                        ObjectManager.Get<Obj_AI_Turret>()
                            .Where(x => x.Distance(ObjectManager.Player) < 5000 && x.IsAlly);

                    if (turret2.Any())
                    {
                        stopdoingshit = true;
                        turret = turret2.First();
                        foundturret = Game.Time;
                    }
                }


                if (stopdoingshit && !recalling)
                {
                    ObjectManager.Player.IssueOrder(GameObjectOrder.MoveTo, turret);
                    if (ObjectManager.Player.Distance(turret) <= 350 && Game.Time - count > 5)
                    {
                        ObjectManager.Player.Spellbook.CastSpell(SpellSlot.Recall);

                        recalling = true;
                        count = Game.Time;
                    }
                }
            }

            //Game.PrintChat((Game.Time - count).ToString());
            if ((Game.Time - count > 15 && Game.Time - count < 17)) //|| Utility.InShopRange())
            {
                stopdoingshit = false;
                recalling = false;
            }

            if (!recalling && !stopdoingshit && W.IsReady())
            {
                var allies2 =
                    ObjectManager.Get<Obj_AI_Hero>()
                        .Where(
                            x =>
                                x.IsAlly && x.Health / x.MaxHealth * 100 < menu.Item("allyhpw").GetValue<Slider>().Value &&
                                !x.IsDead && x.Distance(ObjectManager.Player.Position) < 550);
                var objAiHeroes = allies2 as Obj_AI_Hero[] ?? allies2.ToArray();
                if (objAiHeroes.Any() &&
                    ObjectManager.Player.Health / ObjectManager.Player.MaxHealth * 100 >
                    menu.Item("wabovehp").GetValue<Slider>().Value)
                    W.Cast(objAiHeroes.First());
            }

            if (menu.Item("user").GetValue<bool>() && R.IsReady())
            {
                var allies =
                    ObjectManager.Get<Obj_AI_Hero>()
                        .Where(
                            x =>
                                x.IsAlly && x.Health / x.MaxHealth * 100 < menu.Item("allyhpr").GetValue<Slider>().Value &&
                                !x.IsDead);
                if (allies.Any())
                {
                    if (R.IsReady())
                        R.Cast();
                }
            }

            if (!recalling && !stopdoingshit)
            {
                if (follow.Distance(ObjectManager.Player.Position) > 500)
                    ObjectManager.Player.IssueOrder(GameObjectOrder.MoveTo, follow);
                if (!follow.IsDead)
                {
                    if (W.IsReady() && menu.Item("usew").GetValue<bool>() &&
                        ObjectManager.Player.Health / ObjectManager.Player.MaxHealth * 100 >
                        menu.Item("wabovehp").GetValue<Slider>().Value)
                    {
                        if (follow.Health / follow.MaxHealth * 100 < menu.Item("allyhpw").GetValue<Slider>().Value &&
                            follow.Distance(ObjectManager.Player.Position) < 550 &&
                            ObjectManager.Player.Health / ObjectManager.Player.MaxHealth * 100 >
                            menu.Item("wabovehp").GetValue<Slider>().Value)
                        {
                            W.Cast(follow);
                        }
                        else if (follow.Health / follow.MaxHealth * 100 < menu.Item("allyhpw").GetValue<Slider>().Value &&
                                 follow.Distance(ObjectManager.Player.Position) > 550)
                        {
                            ObjectManager.Player.IssueOrder(GameObjectOrder.MoveTo, follow.Position);
                        }
                    }

                    if (ts.Target.Distance(ObjectManager.Player) < Q.Range && Q.IsReady())
                    {
                        Q.Cast(ts.Target);
                    }

                    if (ts.Target.Distance(ObjectManager.Player) < E.Range && E.IsReady())
                    {
                        E.Cast(ts.Target);
                    }

                    Random x = new Random();
                    var xPos = ((spawn.X - follow.Position.X) / Vector3.Distance(follow.Position, spawn)) * 300 +
                               follow.Position.X -
                               x.Next(25, 150);
                    var yPos = ((spawn.Y - follow.Position.Y) / Vector3.Distance(follow.Position, spawn)) * 300 +
                               follow.Position.Y -
                               x.Next(25, 150);
                    var vec = new Vector3(xPos, yPos, follow.Position.Z);
                    if (
                        NavMesh.GetCollisionFlags(
                            vec.To2D().Extend(ObjectManager.Player.Position.To2D(), 150).To3D())
                            .HasFlag(CollisionFlags.None))
                        ObjectManager.Player.IssueOrder(GameObjectOrder.MoveTo, vec);
                }

                else
                {
                    Random y = new Random();
                    var turret =
                        ObjectManager.Get<Obj_AI_Turret>()
                            .First(x => x.Distance(ObjectManager.Player) < 2000 && x.IsAlly);
                    var xPos = ((spawn.X - turret.Position.X) / Vector3.Distance(turret.Position, spawn)) * 300 +
                               turret.Position.X -
                               y.Next(25, 150);
                    var yPos = ((spawn.Y - turret.Position.Y) / Vector3.Distance(turret.Position, spawn)) * 300 +
                               turret.Position.Y -
                               y.Next(25, 150);

                    var vec = new Vector3(xPos, yPos, follow.Position.Z);
                    ObjectManager.Player.IssueOrder(GameObjectOrder.MoveTo, vec);
                }
            }

        }
    }
}
